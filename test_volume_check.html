<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 볼륨 시각화 및 하드 볼륨 감지 테스트 (디버깅 강화)</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            margin: 0;
        }
        .container {
            max-width: 420px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 28px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border-top: 4px solid #FFD700;
        }
        h2 {
            color: #333333;
            border-bottom: 2px solid #F5F5F5;
            padding-bottom: 12px;
            margin-top: 0;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        /* 캔버스 스타일 */
        #visualizer {
            display: block;
            margin: 20px auto;
            width: 100%;
            max-width: 100%;
            background-color: #F5F7FA;
            border-radius: 6px;
            border: 1px solid #E8ECF1;
        }
        #volumeSlider {
            width: 100%;
            margin: 16px 0;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #FFD700 0%, #FFD700 var(--volume-percent, 100%), #E8ECF1 var(--volume-percent, 100%), #E8ECF1 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }
        #volumeSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }
        label {
            color: #333333;
            font-size: 14px;
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }
        #volumeDisplay {
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333333;
            font-size: 15px;
        }
        #volumeLevel {
            color: #FF8C00;
        }
        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 12px;
        }
        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #FFD700;
            color: #333333;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            letter-spacing: -0.2px;
        }
        button:hover {
            background: #FFED4E;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            background: #FFC700;
        }
        #muteButton {
            background: #F5F5F5;
            color: #666666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        #muteButton:hover {
            background: #EEEEEE;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .note {
            background-color: #FFFEF5;
            border-left: 4px solid #FFD700;
            padding: 14px;
            margin-top: 20px;
            margin-bottom: 24px;
            color: #333333;
            font-size: 13px;
            line-height: 1.6;
            border-radius: 4px;
        }
        /* 하드 볼륨 경고 팝업 스타일 */
        #volumeWarningPopup {
            display: none; 
            background-color: #FFF0F5; 
            border-left: 4px solid #DC143C; 
            padding: 14px; 
            margin-top: 20px; 
            color: #333333; 
            font-size: 14px; 
            line-height: 1.6; 
            border-radius: 4px; 
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>실시간 볼륨 시각화 및 제어</h2>
        
        <div class="note">
            **[사용 설명]**<br>
            1. 아래 **'테스트 재생'** 버튼을 클릭하여 마이크/카메라 접근을 허용합니다.<br>
            2. 하단 슬라이더를 조절하여 볼륨을 확인합니다.<br>
            3. **휴대폰 하드웨어 볼륨을 낮추면** 상단에 경고 메시지가 표시되며 레벨 미터가 낮아집니다.
        </div>
        
        <div id="volumeWarningPopup">
            <span style="font-weight: 700; color: #DC143C;">[필수 조치 필요]</span> 원활한 상담을 위해 **휴대폰 측면의 하드웨어 볼륨 버튼**을 이용하여 소리를 키워주세요. 고객님의 스피커 볼륨이 너무 낮아 상담원에게 소리가 전달되지 않을 수 있습니다.
        </div>

        <audio id="myAudio" src="file_example_MP3_700KB.mp3" type="audio/mp3" preload="auto" loop></audio>

        <canvas id="visualizer" height="40"></canvas>
        
        <label for="volumeSlider">소프트웨어 볼륨 조절</label>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
        
        <div id="volumeDisplay">현재 볼륨: <span id="volumeLevel">100%</span></div>

        <div id="controls">
            <button id="playPauseButton">테스트 재생</button>
            <button id="muteButton">음소거</button>
        </div>
    </div>

    <script>
/*
--------------------------------------------
 Web Audio API 및 글로벌 변수
--------------------------------------------
*/
const audioPlayer = document.getElementById('myAudio');
const volumeSlider = document.getElementById('volumeSlider');
const volumeLevel = document.getElementById('volumeLevel');
const playPauseButton = document.getElementById('playPauseButton');
const muteButton = document.getElementById('muteButton');
const canvas = document.getElementById('visualizer');
const canvasCtx = canvas.getContext('2d');
const $warningPopup = document.getElementById('volumeWarningPopup');

const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let analyser = null; // 오디오 파일 시각화용 Analyser
let source = null; // 오디오 파일 소스

// 신규 추가: 하드 볼륨 감지용 변수
let highFreqOscillator = null; 
let micSource = null; 
let micAnalyser = null; // 마이크 분석용 Analyser
let micStream = null; // getUserMedia로 획득할 미디어 스트림

const TARGET_FREQUENCY = 19000; // 19kHz 고주파
const VOLUME_THRESHOLD = 50; // **** 임계값. 이 값을 콘솔 로그를 보며 조정해야 합니다. ****
let isHardwareVolumeLow = false; // 하드 볼륨 부족 상태 플래그

let audioDataArray = null; // [수정] 오디오 파일 분석 전용 데이터 배열
let micDataArray = null;   // [수정] 마이크 분석 전용 데이터 배열

// ----------------- 캔버스 크기 조절 함수 -----------------
function resizeCanvas() {
    const container = document.querySelector('.container');
    const containerWidth = container.clientWidth - 56; // padding 28px * 2
    canvas.width = containerWidth;
    canvas.style.width = containerWidth + 'px';
}

window.addEventListener('load', () => {
    resizeCanvas();
});

window.addEventListener('resize', () => {
    resizeCanvas();
});


/*
--------------------------------------------
 Web Audio API 설정 및 노드 구성
--------------------------------------------
*/
function setupAudioContext() {
    if (audioCtx) return; 

    // 1. Audio Context 생성
    audioCtx = new AudioContext();
    
    // 2. 오디오 파일 연결: Source -> Destination
    source = audioCtx.createMediaElementSource(audioPlayer);
    source.connect(audioCtx.destination); 
    
    // 3. 시각화용 Analyser 설정 (오디오 파일 시각화에 사용)
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256; 
    
    // 오디오 파일 -> Analyser 연결
    source.connect(analyser);
    
    // [수정] 오디오 파일 분석 전용 데이터 배열 초기화
    audioDataArray = new Uint8Array(analyser.frequencyBinCount);
}

function setupHighFrequencyTone() {
    if (highFreqOscillator) return;

    highFreqOscillator = audioCtx.createOscillator();
    highFreqOscillator.type = 'sine';
    highFreqOscillator.frequency.setValueAtTime(TARGET_FREQUENCY, audioCtx.currentTime); 
    
    const gainNode = audioCtx.createGain();
    gainNode.gain.setValueAtTime(1, audioCtx.currentTime); 

    // 연결: 발진기 -> 볼륨 노드 -> 스피커 출력
    highFreqOscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    highFreqOscillator.start(0); 
    console.log(`[HighFreq] ${TARGET_FREQUENCY}Hz 톤 송출 시작.`);
}

function setupMicrophone(stream) {
    micStream = stream;

    // 1. 마이크 분석기 생성 (하드 볼륨 감지 전용)
    micAnalyser = audioCtx.createAnalyser();
    micAnalyser.fftSize = 2048; // 정밀 분석용
    
    // [수정] 마이크 분석 전용 데이터 배열 초기화
    micDataArray = new Uint8Array(micAnalyser.frequencyBinCount); 
    
    // 2. 마이크 스트림 소스 생성
    micSource = audioCtx.createMediaStreamSource(micStream);
    
    // 3. 연결: 마이크 소스 -> 마이크 분석기
    micSource.connect(micAnalyser); 

    console.log("[Mic] 마이크 스트림 연결 및 분석 준비 완료. FFT Size:", micAnalyser.fftSize);
}


/*
--------------------------------------------
 시각화 함수 (draw) 및 하드 볼륨 감지 통합
--------------------------------------------
*/
function draw() {
    requestAnimationFrame(draw); 

    // ------------------- [A] 마이크 스트림 기반 하드 볼륨 감지 -------------------
    if (micAnalyser) {
        const bufferLength = micAnalyser.frequencyBinCount;
        
        // [수정] 마이크 분석기의 데이터를 전용 배열에 복사
        micAnalyser.getByteFrequencyData(micDataArray); 

        const sampleRate = audioCtx.sampleRate;
        // FFT bin 크기를 이용해 목표 주파수 인덱스 계산
        // index = Freq * (FFTSize / SampleRate) -> Freq * (bufferLength / SampleRate)
        const targetIndex = Math.round(TARGET_FREQUENCY * bufferLength / sampleRate);
        const level = micDataArray[targetIndex]; 

        // ------------------- [디버깅 로그] -------------------
        console.log(`[HighFreq Check] Target Index: ${targetIndex}, Level: ${level}`);
        // ----------------------------------------------------

        if (level < VOLUME_THRESHOLD) {
            isHardwareVolumeLow = true;
            showVolumeWarning();
        } else {
            isHardwareVolumeLow = false;
            hideVolumeWarning();
        }
    }
    // ------------------- [A] 하드 볼륨 감지 끝 -------------------

    // ------------------- [B] 오디오 파일 시각화 -------------------
    if (!analyser || audioPlayer.paused) {
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height); 
        return;
    }

    // [수정] 오디오 파일 Analyser의 데이터를 전용 배열에 복사
    analyser.getByteFrequencyData(audioDataArray); 

    // 배경색 (KB 스타일 밝은 회색)
    canvasCtx.fillStyle = '#F5F5F5';
    canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

    const currentVolume = audioPlayer.volume;
    const isMuted = audioPlayer.muted;

    const barCount = 35;
    const barWidth = (canvas.width / barCount) - 2;
    const maxBarHeight = canvas.height - 4;
    const barSpacing = 2;

    const samplesPerBar = Math.floor(audioDataArray.length / barCount);

    for (let i = 0; i < barCount; i++) {
        let sum = 0;
        const startIdx = i * samplesPerBar;
        const endIdx = Math.min(startIdx + samplesPerBar, audioDataArray.length);
        
        for (let j = startIdx; j < endIdx; j++) {
            // [수정] audioDataArray 사용
            sum += audioDataArray[j];
        }
        const avgValue = sum / (endIdx - startIdx);
        
        // **하드 볼륨 부족 시 시각화 레벨 강제 조정**
        let effectiveVolume = currentVolume;
        if (isHardwareVolumeLow) {
            // 하드 볼륨 부족 시 시각적 경고를 위해 시각화 레벨을 낮춤 (최대 볼륨이라도 20% 수준으로 표시)
            effectiveVolume = 0.2; 
        }
        
        const rawHeight = (avgValue / 255) * maxBarHeight;
        const volumeAdjustedHeight = rawHeight * (isMuted ? 0 : effectiveVolume);
        
        const x = i * (barWidth + barSpacing) + barSpacing;
        const y = canvas.height - volumeAdjustedHeight - 2; 

        if (volumeAdjustedHeight > 2) { 
            if (isMuted || isHardwareVolumeLow) {
                // 음소거이거나 하드 볼륨 부족 시: 경고색 (주황-빨강 계열)
                canvasCtx.fillStyle = isMuted ? '#CCCCCC' : '#FF6347'; 
            } else {
                // 볼륨에 따라 색상 강도 조절 (기존 로직 유지)
                const volumeIntensity = effectiveVolume;
                const r = Math.floor(255 * volumeIntensity);
                const g = Math.floor(215 * volumeIntensity);
                const b = 0;
                canvasCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            }
            canvasCtx.fillRect(x, y, barWidth, volumeAdjustedHeight);
        } else {
            // 비활성화된 막대
            canvasCtx.fillStyle = '#E0E0E0';
            canvasCtx.fillRect(x, canvas.height - 4, barWidth, 2);
        }
    }

    // 볼륨 레벨 인디케이터 그리기 (기존 로직 유지)
    if (!isMuted && currentVolume > 0) {
        const volumeIndicatorY = canvas.height - (currentVolume * maxBarHeight) - 2;
        canvasCtx.strokeStyle = '#FF8C00';
        canvasCtx.lineWidth = 2;
        canvasCtx.setLineDash([4, 4]); // 점선
        canvasCtx.beginPath();
        canvasCtx.moveTo(0, volumeIndicatorY);
        canvasCtx.lineTo(canvas.width, volumeIndicatorY);
        canvasCtx.stroke();
        canvasCtx.setLineDash([]); // 점선 해제
    }
}


/*
--------------------------------------------
 UI/UX 로직 (경고 팝업)
--------------------------------------------
*/
function showVolumeWarning() {
    if ($warningPopup.style.display === 'none') {
        $warningPopup.style.display = 'block';
    }
}

function hideVolumeWarning() {
    if ($warningPopup.style.display === 'block') {
        $warningPopup.style.display = 'none';
    }
}


/*
--------------------------------------------
 볼륨 및 컨트롤 로직 (WebRTC 통합)
--------------------------------------------
*/
// 볼륨 설정 값 저장
function saveVolumeSetting(volume) {
    localStorage.setItem('userVolume', volume);
}

// 볼륨 설정 값 불러오기
function loadVolumeSetting() {
    const savedVolume = localStorage.getItem('userVolume');
    let volume = 1; // 기본값
    if (savedVolume !== null) {
        volume = parseFloat(savedVolume);
    }
    audioPlayer.volume = volume;
    volumeSlider.value = volume;
    volumeLevel.textContent = Math.round(volume * 100) + '%';
    // CSS 변수 업데이트 (슬라이더 배경색 변경)
    volumeSlider.style.setProperty('--volume-percent', (volume * 100) + '%');
}

window.addEventListener('load', loadVolumeSetting);

// 볼륨 슬라이더 조작 시: 볼륨 변경, 표시 업데이트, 값 저장
volumeSlider.addEventListener('input', function() {
    const newVolume = parseFloat(this.value);
    audioPlayer.volume = newVolume;
    volumeLevel.textContent = Math.round(newVolume * 100) + '%';
    saveVolumeSetting(newVolume);
    
    // CSS 변수 업데이트 (슬라이더 배경색 변경)
    volumeSlider.style.setProperty('--volume-percent', (newVolume * 100) + '%');
});


// 재생/일시정지 버튼 토글 및 WebRTC 초기화
playPauseButton.addEventListener('click', function() {
    setupAudioContext(); 
    audioCtx.resume(); 

    if (!micStream) {
        // 1. 마이크 + 웹캠 권한 요청 (getUserInfo 대체 로직)
        navigator.mediaDevices.getUserMedia({ 
            audio: true, // 마이크는 필수
            video: true  // 웹캠 연결 여부 테스트용
        })
        .then(stream => {
            // 스트림 획득 성공
            setupMicrophone(stream); // 마이크 분석기 연결
            setupHighFrequencyTone(); // 고주파 송출 시작

            // 2. 오디오 파일 재생 및 시각화 시작
            if (audioPlayer.paused) {
                audioPlayer.play()
                    .then(() => {
                        playPauseButton.textContent = '일시정지';
                        draw(); // 시각화 및 볼륨 감지 루프 시작
                    })
                    .catch(e => {
                        alert("오디오 재생을 시작할 수 없습니다. 화면을 한 번 클릭한 후 다시 시도해 주세요.");
                    });
            }
        })
        .catch(err => {
            console.error("미디어 접근 오류:", err);
            let message = "미디어(마이크/카메라) 접근이 거부되었습니다. 원활한 상담을 위해 권한을 허용해주세요.";
            if (err.name === "NotAllowedError") {
                 message += " (브라우저 설정 확인 필요)";
            }
            alert(message);
        });
    } else {
        // 마이크 스트림이 이미 있다면, 오디오 파일 재생/일시정지 로직만 실행
        if (audioPlayer.paused) {
            audioPlayer.play();
        } else {
            audioPlayer.pause();
        }
    }
});

// 오디오 재생 상태 변경 감지
audioPlayer.addEventListener('pause', () => {
    playPauseButton.textContent = '테스트 재생';
});
audioPlayer.addEventListener('play', () => {
    playPauseButton.textContent = '일시정지';
});


// 음소거 버튼 토글
muteButton.addEventListener('click', function() {
    audioPlayer.muted = !audioPlayer.muted;
    if (audioPlayer.muted) {
        muteButton.textContent = '음소거 해제';
        volumeLevel.textContent = '음소거';
    } else {
        muteButton.textContent = '음소거';
        volumeLevel.textContent = Math.round(audioPlayer.volume * 100) + '%';
    }
});
    </script>
</body>
</html>

