<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 볼륨 시각화 및 제어</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            margin: 0;
        }
        .container {
            max-width: 420px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 28px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border-top: 4px solid #FFD700;
        }
        h2 {
            color: #333333;
            border-bottom: 2px solid #F5F5F5;
            padding-bottom: 12px;
            margin-top: 0;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        /* 캔버스 스타일 */
        #visualizer {
            display: block;
            margin: 20px auto;
            width: 100%;
            max-width: 100%;
            background-color: #F5F7FA;
            border-radius: 6px;
            border: 1px solid #E8ECF1;
        }
        #volumeSlider {
            width: 100%;
            margin: 16px 0;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #FFD700 0%, #FFD700 var(--volume-percent, 100%), #E8ECF1 var(--volume-percent, 100%), #E8ECF1 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }
        #volumeSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }
        label {
            color: #333333;
            font-size: 14px;
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }
        #volumeDisplay {
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333333;
            font-size: 15px;
        }
        #volumeLevel {
            color: #FF8C00;
        }
        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 12px;
        }
        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #FFD700;
            color: #333333;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            letter-spacing: -0.2px;
        }
        button:hover {
            background: #FFED4E;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            background: #FFC700;
        }
        #muteButton {
            background: #F5F5F5;
            color: #666666;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        #muteButton:hover {
            background: #EEEEEE;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .note {
            background-color: #FFFEF5;
            border-left: 4px solid #FFD700;
            padding: 14px;
            margin-top: 20px;
            margin-bottom: 24px;
            color: #333333;
            font-size: 13px;
            line-height: 1.6;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>실시간 볼륨 시각화 및 제어</h2>
        
        <div class="note">
            테스트 재생 버튼을 클릭하신 후, 슬라이더를 조절하여 볼륨에 따라 레벨 미터가 변화하는 것을 확인하실 수 있습니다.<br>
            (브라우저 정책상 재생 전 화면 클릭이 필요할 수 있습니다.)
        </div>

        <audio id="myAudio" src="file_example_MP3_700KB.mp3" type="audio/mp3" preload="auto" loop></audio>

        <canvas id="visualizer" height="40"></canvas>
        
        <label for="volumeSlider">볼륨 조절</label>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
        
        <div id="volumeDisplay">현재 볼륨: <span id="volumeLevel">100%</span></div>

        <div id="controls">
            <button id="playPauseButton">테스트 재생</button>
            <button id="muteButton">음소거</button>
        </div>
    </div>

    <script>
        const audioPlayer = document.getElementById('myAudio');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeLevel = document.getElementById('volumeLevel');
        const playPauseButton = document.getElementById('playPauseButton');
        const muteButton = document.getElementById('muteButton');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        // ----------------- 캔버스 크기 조절 함수 -----------------
        function resizeCanvas() {
            const container = document.querySelector('.container');
            const containerWidth = container.clientWidth - 56; // padding 28px * 2
            canvas.width = containerWidth;
            canvas.style.width = containerWidth + 'px';
        }

        // 초기 캔버스 크기 설정
        window.addEventListener('load', () => {
            resizeCanvas();
        });

        // 윈도우 리사이즈 시 캔버스 크기 조절
        window.addEventListener('resize', () => {
            resizeCanvas();
        });

        // ----------------- Web Audio API 설정 -----------------
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        let analyser = null;
        let source = null;
        let dataArray = null;

        function setupAudioContext() {
            if (audioCtx) return; 

            // 1. Audio Context 및 Analyser 생성
            audioCtx = new AudioContext();
            analyser = audioCtx.createAnalyser();
            
            // Analyser 설정 (FFT 크기)
            analyser.fftSize = 256; 
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            // 2. 음원 연결: <audio> 태그를 Source Node로
            source = audioCtx.createMediaElementSource(audioPlayer);
            
            // 3. 노드 연결: Source -> Analyser -> Destination
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
        }

        // ----------------- 시각화 함수 -----------------
        function draw() {
            requestAnimationFrame(draw); 

            if (!analyser || audioPlayer.paused) {
                // 일시정지 상태에서는 캔버스를 초기화하고 종료
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height); 
                return;
            }

            // 주파수 데이터 가져오기 (0-255 값)
            analyser.getByteFrequencyData(dataArray); 

            // 배경색 (KB 스타일 밝은 회색)
            canvasCtx.fillStyle = '#F5F5F5';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            // 현재 볼륨 값 가져오기
            const currentVolume = audioPlayer.volume;
            const isMuted = audioPlayer.muted;

            // 레벨 미터: 가로로 배열된 세로 막대들
            const barCount = 35; // 막대 개수
            const barWidth = (canvas.width / barCount) - 2; // 막대 너비 (간격 포함)
            const maxBarHeight = canvas.height - 4; // 최대 막대 높이 (여백 포함)
            const barSpacing = 2; // 막대 사이 간격

            // 주파수 데이터를 샘플링 (전체 데이터를 막대 개수만큼으로 압축)
            const samplesPerBar = Math.floor(dataArray.length / barCount);

            for (let i = 0; i < barCount; i++) {
                // 각 막대에 해당하는 주파수 데이터의 평균값 계산
                let sum = 0;
                const startIdx = i * samplesPerBar;
                const endIdx = Math.min(startIdx + samplesPerBar, dataArray.length);
                
                for (let j = startIdx; j < endIdx; j++) {
                    sum += dataArray[j];
                }
                const avgValue = sum / (endIdx - startIdx);
                
                // 원본 오디오 레벨 기반 막대 높이 계산
                const rawHeight = (avgValue / 255) * maxBarHeight;
                // 볼륨 값을 반영한 실제 표시될 막대 높이
                const volumeAdjustedHeight = rawHeight * (isMuted ? 0 : currentVolume);
                
                // 막대 위치 계산
                const x = i * (barWidth + barSpacing) + barSpacing;
                const y = canvas.height - volumeAdjustedHeight - 2; // 아래에서 위로

                // 막대 그리기
                if (volumeAdjustedHeight > 2) { // 최소 높이 이상일 때만 그리기
                    if (isMuted) {
                        // 음소거일 때 회색
                        canvasCtx.fillStyle = '#CCCCCC';
                    } else {
                        // 볼륨에 따라 색상 강도 조절 (낮은 볼륨일수록 어둡게)
                        const volumeIntensity = currentVolume;
                        // 노란색 계열에서 볼륨에 따라 밝기 조절
                        const r = Math.floor(255 * volumeIntensity);
                        const g = Math.floor(215 * volumeIntensity);
                        const b = 0;
                        canvasCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    }
                    canvasCtx.fillRect(x, y, barWidth, volumeAdjustedHeight);
                } else {
                    // 비활성화된 막대 (밝은 회색)
                    canvasCtx.fillStyle = '#E0E0E0';
                    canvasCtx.fillRect(x, canvas.height - 4, barWidth, 2);
                }
            }

            // 볼륨 레벨 인디케이터 그리기 (시각적 가이드 라인)
            if (!isMuted && currentVolume > 0) {
                const volumeIndicatorY = canvas.height - (currentVolume * maxBarHeight) - 2;
                canvasCtx.strokeStyle = '#FF8C00';
                canvasCtx.lineWidth = 2;
                canvasCtx.setLineDash([4, 4]); // 점선
                canvasCtx.beginPath();
                canvasCtx.moveTo(0, volumeIndicatorY);
                canvasCtx.lineTo(canvas.width, volumeIndicatorY);
                canvasCtx.stroke();
                canvasCtx.setLineDash([]); // 점선 해제
            }
        }


        // ----------------- 볼륨 및 컨트롤 로직 -----------------

        // 볼륨 설정 값 저장
        function saveVolumeSetting(volume) {
            localStorage.setItem('userVolume', volume);
        }

        // 볼륨 설정 값 불러오기
        function loadVolumeSetting() {
            const savedVolume = localStorage.getItem('userVolume');
            let volume = 1; // 기본값
            if (savedVolume !== null) {
                volume = parseFloat(savedVolume);
            }
            audioPlayer.volume = volume;
            volumeSlider.value = volume;
            volumeLevel.textContent = Math.round(volume * 100) + '%';
            // CSS 변수 업데이트 (슬라이더 배경색 변경)
            volumeSlider.style.setProperty('--volume-percent', (volume * 100) + '%');
        }

        window.addEventListener('load', loadVolumeSetting);

        // 볼륨 슬라이더 조작 시: 볼륨 변경, 표시 업데이트, 값 저장
        volumeSlider.addEventListener('input', function() {
            const newVolume = parseFloat(this.value);
            audioPlayer.volume = newVolume;
            volumeLevel.textContent = Math.round(newVolume * 100) + '%';
            saveVolumeSetting(newVolume);
            
            // CSS 변수 업데이트 (슬라이더 배경색 변경)
            volumeSlider.style.setProperty('--volume-percent', (newVolume * 100) + '%');
        });


        // 재생/일시정지 버튼 토글
        playPauseButton.addEventListener('click', function() {
            setupAudioContext(); 
            audioCtx.resume(); 

            if (audioPlayer.paused) {
                audioPlayer.play()
                    .then(() => {
                        playPauseButton.textContent = '일시정지';
                        draw(); // 재생 성공 시 시각화 시작
                    })
                    .catch(e => {
                        alert("오디오 재생을 시작할 수 없습니다.\n화면을 한 번 클릭한 후 다시 시도해 주세요.");
                    });
            } else {
                audioPlayer.pause();
            }
        });

        // 오디오 재생 상태 변경 감지
        audioPlayer.addEventListener('pause', () => {
             playPauseButton.textContent = '테스트 재생';
        });
        audioPlayer.addEventListener('play', () => {
             playPauseButton.textContent = '일시정지';
        });


        // 음소거 버튼 토글
        muteButton.addEventListener('click', function() {
            audioPlayer.muted = !audioPlayer.muted;
            if (audioPlayer.muted) {
                muteButton.textContent = '음소거 해제';
                volumeLevel.textContent = '음소거';
            } else {
                muteButton.textContent = '음소거';
                volumeLevel.textContent = Math.round(audioPlayer.volume * 100) + '%';
            }
        });
    </script>
</body>
</html>
